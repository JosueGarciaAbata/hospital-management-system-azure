name: Build Changed Services

on:
  push:
    branches:
      - main
      - dev

jobs:
  detect-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Azure Container Registry
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Detect changed services and build
        id: build
        run: |
          echo "Detectando cambios..."
          if [ $(git rev-list --count HEAD) -gt 1 ]; then
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          else
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
          fi

          echo "Archivos modificados:"
          echo "$CHANGED_FILES"

          SERVICES=("auth-service" "consulting-service" "report-service" "frontend")

          for SERVICE in "${SERVICES[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^$SERVICE/"; then
              echo "ðŸŸ¢ Se detectÃ³ cambio en: $SERVICE"
              IMAGE="${{ secrets.ACR_NAME }}.azurecr.io/${SERVICE}:${{ github.sha }}"
              echo "Construyendo imagen $IMAGE"
              docker build -t $IMAGE -f Dockerfile-$SERVICE .
              docker push $IMAGE
              echo "$SERVICE=$IMAGE" >> $GITHUB_OUTPUT
            else
              echo "âšª Sin cambios en: $SERVICE"
            fi
          done
