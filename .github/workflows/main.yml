name: Build & Push Changed Microservices to Azure Container Registry

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clonar repo con suficiente historial (para git diff)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      # 2Ô∏è‚É£ Configurar JDK (Spring Boot usa Maven/Gradle)
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3Ô∏è‚É£ Compilar proyecto completo
      - name: Build Maven packages
        run: mvn clean package -DskipTests

      # 4Ô∏è‚É£ Iniciar sesi√≥n en Azure Container Registry (ACR)
      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: hospitalregistry.azurecr.io
          username: ${{ secrets.AZURE_ACR_USERNAME }}
          password: ${{ secrets.AZURE_ACR_PASSWORD }}

      # 5Ô∏è‚É£ Detectar microservicios modificados y subirlos al ACR
      - name: Detect changed microservices and build selectively
        run: |
          echo "üîç Detectando microservicios modificados..."

          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            echo "Archivos modificados:"
            echo "$CHANGED_FILES"
          else
            echo "‚ö†Ô∏è Primer commit detectado. Se construir√°n todos los servicios."
            CHANGED_FILES=$(ls -d */ | grep -E 'service|gateway|server')
          fi

          echo "{" > deploy-info.json

          build_and_push() {
            SERVICE_NAME=$1
            DOCKERFILE=$2
            IMAGE_NAME=hospitalregistry.azurecr.io/${SERVICE_NAME}:v${{ github.run_number }}
          
            echo "üöÄ Construyendo $SERVICE_NAME..."
            docker build -t $IMAGE_NAME -f $DOCKERFILE .
            echo "üì§ Subiendo imagen al Azure Container Registry..."
            docker push $IMAGE_NAME
            echo "‚úÖ Imagen subida: $IMAGE_NAME"

            echo "\"$SERVICE_NAME\": \"$IMAGE_NAME\"," >> deploy-info.json
          }

          if echo "$CHANGED_FILES" | grep -q "auth-service"; then
            build_and_push "auth-service" "Dockerfile-auth-service"
          fi

          if echo "$CHANGED_FILES" | grep -q "admin-service"; then
            build_and_push "admin-service" "Dockerfile-admin-service"
          fi

          if echo "$CHANGED_FILES" | grep -q "consulting-service"; then
            build_and_push "consulting-service" "Dockerfile-consulting-service"
          fi

          if echo "$CHANGED_FILES" | grep -q "report-service"; then
            build_and_push "report-service" "Dockerfile-report-service"
          fi

          if echo "$CHANGED_FILES" | grep -q "hospital-gateway"; then
            build_and_push "hospital-gateway" "Dockerfile-hospital-gateway"
          fi

          if echo "$CHANGED_FILES" | grep -q "hospital-eureka-server"; then
            build_and_push "hospital-eureka-server" "Dockerfile-hospital-eureka-server"
          fi

          # Limpiar √∫ltima coma y cerrar JSON
          sed -i '$ s/,$//' deploy-info.json
          echo "}" >> deploy-info.json

      # 6Ô∏è‚É£ Guardar registro de im√°genes generadas (artefacto)
      - name: Upload deploy info
        uses: actions/upload-artifact@v3
        with:
          name: deploy-info
          path: deploy-info.json
