name: Build and Push Changed Microservices

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Maven packages
        run: mvn clean package -DskipTests

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: hospitalregistry.azurecr.io
          username: ${{ secrets.AZURE_ACR_USERNAME }}
          password: ${{ secrets.AZURE_ACR_PASSWORD }}

      - name: Detect changed microservices and build selectively
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files: $CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "auth-service"; then
            echo "Building auth-service..."
            docker build -t hospitalregistry.azurecr.io/auth-service:v${{ github.run_number }} -f Dockerfile-auth-service .
            docker push hospitalregistry.azurecr.io/auth-service:v${{ github.run_number }}
          fi

          if echo "$CHANGED_FILES" | grep -q "admin-service"; then
            echo "Building admin-service..."
            docker build -t hospitalregistry.azurecr.io/admin-service:v${{ github.run_number }} -f Dockerfile-admin-service .
            docker push hospitalregistry.azurecr.io/admin-service:v${{ github.run_number }}
          fi

          if echo "$CHANGED_FILES" | grep -q "consulting-service"; then
            echo "Building consulting-service..."
            docker build -t hospitalregistry.azurecr.io/consulting-service:v${{ github.run_number }} -f Dockerfile-consulting-service .
            docker push hospitalregistry.azurecr.io/consulting-service:v${{ github.run_number }}
          fi

          if echo "$CHANGED_FILES" | grep -q "report-service"; then
            echo "Building report-service..."
            docker build -t hospitalregistry.azurecr.io/report-service:v${{ github.run_number }} -f Dockerfile-report-service .
            docker push hospitalregistry.azurecr.io/report-service:v${{ github.run_number }}
          fi

          if echo "$CHANGED_FILES" | grep -q "hospital-gateway"; then
            echo "Building hospital-gateway..."
            docker build -t hospitalregistry.azurecr.io/hospital-gateway:v${{ github.run_number }} -f Dockerfile-hospital-gateway .
            docker push hospitalregistry.azurecr.io/hospital-gateway:v${{ github.run_number }}
          fi

          if echo "$CHANGED_FILES" | grep -q "hospital-eureka-server"; then
            echo "Building hospital-eureka-server..."
            docker build -t hospitalregistry.azurecr.io/hospital-eureka-server:v${{ github.run_number }} -f Dockerfile-hospital-eureka-server .
            docker push hospitalregistry.azurecr.io/hospital-eureka-server:v${{ github.run_number }}
          fi
